<!DOCTYPE html>
<html>
<head>
    <title>CharityTrades</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const API = 'http://localhost:8080/api';

        function App() {
            const [page, setPage] = React.useState('projects');
            const [selectedProject, setSelectedProject] = React.useState(null);
            const [currentOrder, setCurrentOrder] = React.useState(null);
            const [user, setUser] = React.useState(null);

            React.useEffect(() => {
                fetch(`${API}/users/1`).then(r => r.json()).then(setUser);
            }, []);

            if (page === 'projects') {
                return <ProjectsPage
                    onSelect={(p) => { setSelectedProject(p); setPage('donate'); }}
                />;
            }
            if (page === 'donate') {
                return <DonatePage
                    project={selectedProject}
                    userId={user?.id || 1}
                    onOrder={(o) => { setCurrentOrder(o); setPage('status'); }}
                    onBack={() => setPage('projects')}
                />;
            }
            if (page === 'status') {
                return <StatusPage
                    order={currentOrder}
                    onBack={() => setPage('projects')}
                    onSettle={(o) => setCurrentOrder(o)}
                />;
            }
        }

        function ProjectsPage({ onSelect }) {
            const [projects, setProjects] = React.useState([]);
            const [matchers, setMatchers] = React.useState([]);

            React.useEffect(() => {
                fetch(`${API}/projects`).then(r => r.json()).then(setProjects);
                fetch(`${API}/matching-orders`).then(r => r.json()).then(setMatchers);
            }, []);

            const getMatchersForProject = (projectId) => {
                return matchers.filter(m => m.projectId === projectId && m.remainingAmount > 0);
            };

            return (
                <div>
                    <h1>CharityTrades - Projects</h1>
                    <p>Select a project to donate. Projects with matchers will multiply your impact.</p>
                    <hr/>
                    {projects.map(p => {
                        const projectMatchers = getMatchersForProject(p.id);
                        const bestRatio = projectMatchers.length > 0
                            ? Math.max(...projectMatchers.map(m => m.matchRatio))
                            : 0;
                        return (
                            <div key={p.id} style={{marginBottom: '20px', padding: '10px', border: '1px solid #ccc'}}>
                                <h3>{p.name}</h3>
                                <p>{p.description?.substring(0, 200)}...</p>
                                <p>Charity: {p.charityName} | Min: ${p.minimumAmount}</p>
                                {projectMatchers.length > 0 ? (
                                    <p><strong>MATCHERS AVAILABLE: {bestRatio}:1 ratio</strong></p>
                                ) : (
                                    <p><em>No matchers (direct donation)</em></p>
                                )}
                                <button onClick={() => onSelect(p)}>Donate to this project</button>
                            </div>
                        );
                    })}
                </div>
            );
        }

        function DonatePage({ project, userId, onOrder, onBack }) {
            const [amount, setAmount] = React.useState(project.minimumAmount || 10);
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);

            const handleSubmit = async () => {
                setLoading(true);
                setError(null);
                try {
                    const res = await fetch(`${API}/orders`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId, projectId: project.id, amount: parseFloat(amount) })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        onOrder(data);
                    } else {
                        setError(data.error || 'Failed to place order');
                    }
                } catch (e) {
                    setError(e.message);
                }
                setLoading(false);
            };

            return (
                <div>
                    <h1>Place Donation Order</h1>
                    <button onClick={onBack}>Back to Projects</button>
                    <hr/>
                    <h2>{project.name}</h2>
                    <p>{project.description?.substring(0, 300)}...</p>
                    <p>Minimum: ${project.minimumAmount}</p>
                    <hr/>
                    <label>
                        Amount: $
                        <input
                            type="number"
                            value={amount}
                            onChange={e => setAmount(e.target.value)}
                            min={project.minimumAmount}
                        />
                    </label>
                    <br/><br/>
                    <button onClick={handleSubmit} disabled={loading}>
                        {loading ? 'Placing order...' : 'Place Order'}
                    </button>
                    {error && <p style={{color: 'red'}}>{error}</p>}
                </div>
            );
        }

        function StatusPage({ order, onBack, onSettle }) {
            const [settling, setSettling] = React.useState(false);

            const handleSettle = async () => {
                setSettling(true);
                const res = await fetch(`${API}/orders/${order.id}/settle`, { method: 'POST' });
                const data = await res.json();
                onSettle(data);
                setSettling(false);
            };

            return (
                <div>
                    <h1>Order Status</h1>
                    <button onClick={onBack}>Back to Projects</button>
                    <hr/>

                    <h2>Trade Lifecycle</h2>
                    <LifecycleVisualization status={order.status} />

                    <hr/>
                    <h2>Order Details</h2>
                    <table border="1" cellPadding="8">
                        <tbody>
                            <tr><td>Order ID</td><td>{order.id}</td></tr>
                            <tr><td>Status</td><td><strong>{order.status}</strong></td></tr>
                            <tr><td>Route</td><td>{order.routeType}</td></tr>
                            <tr><td>Your Amount</td><td>${order.amount}</td></tr>
                            <tr><td>Matched Amount</td><td>${order.matchedAmount || 0}</td></tr>
                            <tr><td>Total Impact</td><td><strong>${order.totalImpact}</strong></td></tr>
                            {order.matchedWithCorporate && (
                                <tr><td>Matched By</td><td>{order.matchedWithCorporate}</td></tr>
                            )}
                        </tbody>
                    </table>

                    {order.donationLink && (
                        <div>
                            <br/>
                            <p>Donation Link: <a href={order.donationLink} target="_blank">{order.donationLink}</a></p>
                        </div>
                    )}

                    {(order.status === 'MATCHED' || order.status === 'EXECUTED') && (
                        <div>
                            <br/>
                            <p>After donating on GlobalGiving, click to settle:</p>
                            <button onClick={handleSettle} disabled={settling}>
                                {settling ? 'Settling...' : 'Settle Order'}
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        function LifecycleVisualization({ status }) {
            const stages = ['NEW', 'VALIDATED', 'ROUTED', 'MATCHED', 'CLEARING', 'SETTLED'];
            const alternateStages = ['NEW', 'VALIDATED', 'ROUTED', 'EXECUTED', 'CLEARING', 'SETTLED'];

            const isExecuted = status === 'EXECUTED';
            const displayStages = isExecuted ? alternateStages : stages;

            const currentIndex = displayStages.indexOf(status);

            return (
                <div>
                    <div style={{display: 'flex', alignItems: 'center', gap: '5px', fontFamily: 'monospace'}}>
                        {displayStages.map((stage, i) => {
                            let symbol = '○';
                            if (i < currentIndex) symbol = '●';
                            if (i === currentIndex) symbol = '◉';

                            return (
                                <React.Fragment key={stage}>
                                    <span style={{
                                        fontWeight: i === currentIndex ? 'bold' : 'normal',
                                        color: i <= currentIndex ? 'green' : 'gray'
                                    }}>
                                        {symbol} {stage}
                                    </span>
                                    {i < displayStages.length - 1 && <span>→</span>}
                                </React.Fragment>
                            );
                        })}
                    </div>
                    <br/>
                    <div style={{fontFamily: 'monospace', fontSize: '12px'}}>
                        {status === 'NEW' && 'Order submitted'}
                        {status === 'VALIDATED' && 'Credit Risk Manager approved (amount >= minimum)'}
                        {status === 'ROUTED' && 'Router picked route: CLOB or DIRECT'}
                        {status === 'MATCHED' && 'Paired with corporate matcher via CLOB'}
                        {status === 'EXECUTED' && 'No matcher available, routed DIRECT'}
                        {status === 'CLEARING' && 'Post-trade verification'}
                        {status === 'SETTLED' && 'Complete - donation finalized'}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
